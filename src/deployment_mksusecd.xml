<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook"
         xmlns:its="http://www.w3.org/2005/11/its"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         version="5.2"
         role="General"
         xml:id="cha-deployment-prep-mksusecd">
   <title>Customizing installation images with mksusecd</title>
   <info>
      <abstract>
         <para><command>mksusecd</command> is a useful tool for creating a customized installation image. Use it to modify the regular SUSE Linux Enterprise installation images, add or remove files, create a minimal network installation image, customize boot options or software repositories, and create a minimal boot image as an alternative to booting a system from a PXE server.</para>
      </abstract>
   </info>
   <sect1 xml:id="sec-deployment-install-mksusecd">
      <title>Installing mksusecd</title>
      <para>In SLE 15, <command>mksusecd</command> is in the <literal>Development Tools</literal> module. If this module is not enabled, you must enable it first. Find the exact module name and <command>SUSEConnect</command> activation command with <command>zypper</command>:</para>
      <screen><prompt>&gt;</prompt>zypper search-packages mksusecd
Following packages were found in following modules:

Package              Module or Repository
-------------------- -------------------------------------------------------------------
---------------------- -----------------------------------------------------------------
mksusecd             Development Tools Module (sle-module-development-tools/15.4/x86_64)
                       SUSEConnect --product sle-module-development-tools/15.4/x86_64

To activate the respective module or product, use SUSEConnect --product.
Use SUSEConnect --help for more details.</screen>
      <para>Enable the module with SUSEConnect:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> SUSEConnect --product sle-module-development-tools/15.4/x86_64</screen>
      <para>Install <command>mksusecd</command>:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> zypper in mksusecd</screen>
      <para>Run <command>mksusecd --help</command> to see a complete list of commands.</para>
      <para>After you create your custom image, either burn it to a CD/DVD medium using your preferred disk-writing program, or create a bootable USB flash drive using the <command>dd</command> command. Make sure the device is not mounted, then run the following command:</para>
      <screen><prompt role="root">#</prompt><command>dd</command> if=<replaceable>myinstaller.iso</replaceable> of=/dev/<replaceable>SDB</replaceable> bs=4M</screen>
      <para>Then your new bootable device is ready to use.</para>
   </sect1>
   <sect1 xml:id="sec-deployment-prep-boot-mksusecd">
      <title>Creating a minimal boot image</title>
      <para>Use <command>mksusecd</command> to create a minimal boot image to start client machines from a CD/DVD or USB flash drive, instead of starting them from a PXE boot server. The minimal boot image launches the kernel and initrd, and then the remaining installation files are fetched from a local NFS server (see <xref linkend="sec-deployment-instserver-sles9"/>).</para>
      <para>Run the following command to create the minimal ISO image:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command><command>mksusecd</command> --create <replaceable>min-install.iso</replaceable> \
--net=nfs://<replaceable>192.168.1.1:/srv/install/</replaceable><replaceable>ARCH</replaceable>/<replaceable>OS_VERSION</replaceable>/<replaceable>SP_VERSION</replaceable>/cd1  \
/srv/tftpboot/EFI/<replaceable>ARCH</replaceable>/boot</screen>
      <para>Replace the NFS server address with your own. Replace <replaceable>ARCH</replaceable> with the directory corresponding to the target system architecture. Also replace <replaceable>OS_version</replaceable> and <replaceable>SP_VERSION</replaceable> (service pack) according to your paths in <xref linkend="sec-deployment-instserver-sles9"/>.</para>
      <!-- the mksusecd chapter is not included in any OSUSE build, and the example
  command here is not valid for SLE. cschroder, 01-15-2020 -->
   </sect1>
   <sect1 xml:id="sec-deployment-custom-image-boot">
      <title>Setting default kernel boot parameters</title>
      <para>Rather than waiting for a boot prompt to enter your custom kernel boot parameters, configure them in a custom <command>mksusecd</command> image:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> mksusecd --create <replaceable>install.iso</replaceable> \
--boot "<replaceable>textmode=1 splash=silent mitigations=auto</replaceable>"</screen>
      <para>Verify that your custom parameters load correctly after start-up by querying <filename>/proc</filename>:</para>
      <screen><prompt>&gt;</prompt>cat /proc/cmdline</screen>
   </sect1>
   <sect1 xml:id="sec-deployment-custom-modules">
      <title>Customizing modules, extensions, and repositories</title>
      <para>SUSE Linux Enterprise 15 supports Modules (not to be confused with kernel modules) and Extensions for different product components. These are add-ons to the default <literal>Basesystem</literal>, such as <literal>Development Tools</literal>, <literal>Desktop Applications</literal>, and SUSE Linux Enterprise <literal>Live Patching</literal>. For more information refer to the Modules and Extensions Quick Start guide.</para>
      <para>With <command>mksusecd</command> you can create an installation image containing all additional Modules and Extensions you want. Start by querying existing images, like this example for SUSE Linux Enterprise <phrase role="productnumber">15 SP7</phrase>:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> mksusecd --list-repos SLE-15-SP7-Full-<replaceable>ARCH</replaceable>-GM-media1.iso
Repositories:
  Basesystem-Module [15.7-0]
  SUSE-CAP-Tools-Module [15.7-0]
  Containers-Module [15.7-0]
  Desktop-Applications-Module [15.7-0]
  Development-Tools-Module [15.7-0]
  HPC-Module [15.7-0]
  Legacy-Module [15.7-0]
  Live-Patching [15.7-0]
  Public-Cloud-Module [15.7-0]
  Python2-Module [15.7-0]
  SAP-Applications-Module [15.7-0]
  Server-Applications-Module [15.7-0]
  Transactional-Server-Module [15.7-0]
  Web-Scripting-Module [15.7-0]
  SLEHA15-SP7 [15.7-0]
  SLE-15-SP7-HPC [15.7-0]
  SLED15-SP7 [15.7-0]
  SLES15-SP7 [15.7-0]
  SLE-15-SP7-SAP [15.7-0]
  SLEWE15-SP7 [15.7-0]
  [...]
</screen>
      <para>Create a new installation image that is built from the Modules, Extensions, and repositories that you select, and automatically enable them:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> mksusecd --create <replaceable>myinstaller.iso</replaceable> --enable-repos auto \
--include-repos <replaceable>Basesystem-Module,Desktop-Applications-Module</replaceable> \
SLE-15-SP7-Full-<replaceable>ARCH</replaceable>-GM-media1.iso</screen>
      <para>This example creates an image for installation from the internet. To create an image for offline installation, additionally add the repository of the base product, for example <literal>SLES15-SP7</literal> for SUSE Linux Enterprise Server.</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> mksusecd --create <replaceable>myinstaller.iso</replaceable> --enable-repos auto \
   --include-repos <replaceable>SLES15-SP7,Basesystem-Module,Desktop-Applications-Module</replaceable> \
   SLE-15-SP7-Full-<replaceable>ARCH</replaceable>-GM-media1.iso</screen>
      <para>Replace <option>--enable-repos auto</option> with <option>--enable-repos ask</option> to have the installer present a dialog for choosing modules.</para>
      <note>
         <title>AutoYaST control file</title>
         <para>When using the <option>--enable-repos</option> option, <command>mksusecd</command> adds an <filename>add_on_products.xml</filename> file for use with AutoYaST to the new image. Modules in this file do not need to be listed in the in the AutoYaST control file.</para>
      </note>
   </sect1>
   <sect1 xml:id="sec-deployment-custom-netinstall">
      <title>Creating a minimal netinstall ISO</title>
      <para>To create a minimal installation image to launch a network installation, use the <command>--nano</command> option:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> mksusecd --create <replaceable>netinstall.iso</replaceable> \
--nano SLE-15-SP7-Online-<replaceable>ARCH</replaceable>-GM-media1.iso</screen>
   </sect1>
   <sect1 xml:id="sec-deployment-custom-repo">
      <title>Change default repository</title>
      <para>To set a different repository, such as your own local repository, use the <command>--net</command> option:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> mksusecd --create <replaceable>localinstall.iso</replaceable> \
--net "https://example.com/local" SLE-15-SP7-Online-<replaceable>ARCH</replaceable>-GM-media1.iso</screen>
   </sect1>
</chapter>
