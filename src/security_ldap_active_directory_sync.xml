<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook"
       xmlns:its="http://www.w3.org/2005/11/its"
       xmlns:xi="http://www.w3.org/2001/XInclude"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="5.2"
       xml:id="sec-security-ldap-active-directory-sync">
   <info>
      <title>Synchronizing with Microsoft Active Directory</title>
   </info>
   <para>389 Directory Server supports synchronizing certain user and group content from Microsoft's Active Directory, so that Linux clients can use 389 DS for their identity information without the normally required domain join process. This also allows 389 DS to extend and use its other features with the data synchronized from Active Directory.</para>
   <sect2 xml:id="sec-security-ldap-synchronization-planning">
      <title>Planning your synchronization topology</title>
      <para>Due to how the synchronization works, only a single 389 Directory Server and Active Directory server are involved. The Active Directory server must be a full Domain Controller, and not a Read Only Domain Controller (RODC). The Global Catalog is not required on the DC that is synchronized, as 389 DS only replicates the content of a single forest in a domain.</para>
      <para>You must first choose the direction of your data flow. There are three options: from AD to 389 DS, from 389 DS to AD, or bi- directional.</para>
      <note>
         <title>No password synchronization</title>
         <para>Passwords cannot be synchronized between 389 DS and Active Directory. This may change in the future, to support Active Directory to 389 DS password flow.</para>
      </note>
      <para>Your topology looks like the following diagram. The 389 Directory Server and Active Directory topologies may differ, but the most important factor is to have only a single connection between 389 DS and Active Directory. It is important to account for this in your disaster recovery and backup plans for both 389 DS and AD, to ensure that you correctly restore only a single replication connection between these topologies.</para>
      <screen><?dbfo keep-together="always"?>
┌────────┐     ┌────────┐         ┌────────┐     ┌────────┐
│        │     │        │         │        │     │        │
│ 389-ds │◀───▶│ 389-ds │◀ ─ ─ ─ ▶│   AD   │◀───▶│   AD   │
│        │     │        │         │        │     │        │
└────────┘     └────────┘         └────────┘     └────────┘
    ▲               ▲                  ▲             ▲
    │               │                  │             │
    ▼               ▼                  ▼             ▼
┌────────┐     ┌────────┐         ┌────────┐     ┌────────┐
│        │     │        │         │        │     │        │
│ 389-ds │◀───▶│ 389-ds │         │   AD   │◀───▶│   AD   │
│        │     │        │         │        │     │        │
└────────┘     └────────┘         └────────┘     └────────┘
</screen>
   </sect2>
   <sect2 xml:id="sec-security-ldap-synchronization-ad-prerequisites">
      <title>Prerequisites for Active Directory</title>
      <para>A security group that is granted the <literal>Replicating Directory Changes</literal> permission is required. For example, you have created a group named <literal>Directory Server Sync</literal>. Follow the steps in the <citetitle>How to grant the 'Replicating Directory Changes' permission for the Microsoft Metadirectory Services ADMA service account</citetitle> (<link xlink:href="https://docs.microsoft.com/en-US/troubleshoot/windows-server/windows-security/grant-replicating-directory-changes-permission-adma-service"/> to set this up.</para>
      <warning>
         <title>Strong security needed</title>
         <para>You should consider members of this group to be of equivalent security importance to Domain Administrators. Members of this group have the ability to read sensitive content from the Active Directory environment, so you should use strong, randomly generated service account passwords for these accounts, and carefully audit membership to this group.</para>
      </warning>
      <para>You should also create a service account that is a member of this group.</para>
      <para>Your Active Directory environment must have certificates configured for LDAPS to ensure that authentication between 389 DS and AD is secure. Authentication with Generic Security Services API/Kerberos (GSSAPI/KRB) cannot be used.</para>
   </sect2>
   <sect2 xml:id="sec-security-ldap-synchronization-389ds-prerequisites">
      <title>Prerequisites for 389 Directory Server</title>
      <para>The 389 Directory Server must have a back-end database already configured with Organization Units (OUs) for entries to be synchronized into.</para>
      <para>The 389 Directory Server must have a replica ID configured as though the server is a read-write replica. (For details about setting up replication see <xref linkend="sec-security-ldap-replication"/>).</para>
   </sect2>
   <sect2 xml:id="sec-security-ldap-synchronization-agreement">
      <title>Creating an agreement from Active Directory to 389 Directory Server</title>
      <para>The following example command, which is run on the 389 Directory Server, creates a replication agreement from Active Directory to 389 Directory Server:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command><command>dsconf <replaceable>INSTANCE-NAME</replaceable> repl-winsync-agmt create --suffix <replaceable>dc=example,dc=com</replaceable></command> \
  <command>--host <replaceable>AD-HOSTNAME</replaceable> --port 636 --conn-protocol LDAPS</command> \
  --bind-dn <command>"<replaceable>cn=SERVICE-ACCOUNT,cn=USERS,dc=AD,dc=EXAMPLE,dc=COM</replaceable>"</command> \
  <command>--bind-passwd "<replaceable>PASSWORD</replaceable>" --win-subtree "<replaceable>cn=USERS,dc=AD,dc=EXAMPLE,dc=COM</replaceable>"</command> \
  <command>--ds-subtree <replaceable>ou=AD,dc=EXAMPLE,dc=COM</replaceable> --one-way-sync fromWindows</command> \
  <command>--sync-users=on --sync-groups=on --move-action delete</command> \
  <command>--win-domain <replaceable>AD-DOMAIN</replaceable> adsync_agreement</command></screen>
      <para>Once the agreement has been created, you must perform an initial resynchronization:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command><command>dsconf <replaceable>INSTANCE-NAME</replaceable> repl-winsync-agmt init --suffix <replaceable>dc=example,dc=com</replaceable> adsync_agreement</command></screen>
      <para>Use the following command to check the status of the initialization:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command><command>dsconf <replaceable>INSTANCE-NAME</replaceable> repl-winsync-agmt init-status --suffix <replaceable>dc=example,dc=com</replaceable> adsync_agreement</command></screen>
      <note>
         <title>Some entries are not synchronized</title>
         <para>In some cases, an entry may not be synchronized, even if the init status reports success. Check your 389 DS log files in <filename>/var/log/dirsrv/slapd-INSTANCE-NAME/errors</filename>.</para>
      </note>
      <para>Check the status of the agreement with the following command:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command><command>dsconf <replaceable>INSTANCE-NAME</replaceable> repl-winsync-agmt status --suffix <replaceable>dc=example,dc=com</replaceable> adsync_agreement</command></screen>
      <para>Whe you are performing maintenance on the Active Directory or 389 Directory Server topology, you can pause the agreement with the following command:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command><command>dsconf <replaceable>INSTANCE-NAME</replaceable> repl-winsync-agmt disable --suffix <replaceable>dc=example,dc=com</replaceable> adsync_agreement</command></screen>
      <para>Resume the agreement with the following command:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command><command>dsconf <replaceable>INSTANCE-NAME</replaceable> repl-winsync-agmt enable --suffix <replaceable>dc=example,dc=com</replaceable> adsync_agreement</command></screen>
   </sect2>
</sect1>
