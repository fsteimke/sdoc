<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook"
         xmlns:its="http://www.w3.org/2005/11/its"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         version="5.2"
         xml:id="cha-vt-installation">
   <title>Installation of virtualization components</title>
   <info/>
   <sect1 xml:id="introduction-install-virtualization-components">
      <title>Introduction</title>
      <para>To run a virtualization server (VM Host Server) that can host one or more guest systems (VM Guests), you need to install required virtualization components on the server. These components vary depending on which virtualization technology you want to use.</para>
   </sect1>
   <sect1 xml:id="install-virtualization-components">
      <title>Installing virtualization components</title>
      <para>You can install the virtualization tools required to run a VM Host Server in one of the following ways:</para>
      <itemizedlist>
         <listitem>
            <para>By selecting a specific system role during <phrase role="productname">SUSE Linux Enterprise Server</phrase> installation on the VM Host Server</para>
         </listitem>
         <listitem>
            <para>By running the <emphasis>YaST Virtualization</emphasis> module on an already installed and running <phrase role="productname">SUSE Linux Enterprise Server</phrase>.</para>
         </listitem>
         <listitem>
            <para>By installing specific installation patterns on an already installed and running <phrase role="productname">SUSE Linux Enterprise Server</phrase>.</para>
         </listitem>
      </itemizedlist>
      <sect2 xml:id="install-virtualization-components-system-role">
         <title>Specifying a system role</title>
         <para>You can install all the tools required for virtualization during the installation of <phrase role="productname">SUSE Linux Enterprise Server</phrase> on the VM Host Server. During the installation, you are presented with the <guimenu>System Role</guimenu> screen.</para>
         <figure>
            <title>System Role screen</title>
            <mediaobject>
               <imageobject outputformat="print">
                  <imagedata fileref="media/virt-system-roles.png" width="75%"/>
               </imageobject>
               <imageobject outputformat="screen">
                  <imagedata fileref="media/virt-system-roles.png" width="75%"/>
               </imageobject>
            </mediaobject>
         </figure>
         <para>Here you can select either the <guimenu>KVM Virtualization Host</guimenu> or the <guimenu>Xen Virtualization Host</guimenu> roles. The appropriate software selection and setup is automatically performed during <phrase role="productname">SUSE Linux Enterprise Server</phrase> installation.</para>
         <tip>
            <para>Both virtualization system roles create a dedicated <filename>/var/lib/libvirt</filename> partition, and enable the <systemitem class="daemon">firewalld</systemitem> and Kdump services.</para>
         </tip>
      </sect2>
      <sect2 xml:id="install-virtualization-components-yast">
         <title>Running the <emphasis>YaST Virtualization</emphasis> module</title>
         <para>Depending on the scope of <phrase role="productname">SUSE Linux Enterprise Server</phrase> installation on the VM Host Server, none of the virtualization tools may be installed on your system. They are automatically installed when configuring the hypervisor with the <emphasis>YaST Virtualization</emphasis> module.</para>
         <tip>
            <para>The <emphasis>YaST Virtualization</emphasis> module is included in the <package>yast2-vm</package> package. Verify it is installed on the VM Host Server before installing virtualization components.</para>
         </tip>
         <procedure>
            <title>Installing the KVM environment</title>
            <para>To install the KVM virtualization environment and related tools, proceed as follows:</para>
            <step>
               <para>Start YaST and select <menuchoice>
                     <guimenu>Virtualization</guimenu>
                     <guimenu>Install Hypervisor and Tools</guimenu>
                  </menuchoice>.</para>
            </step>
            <step>
               <para>Select <guimenu>KVM server</guimenu> for a minimal installation of QEMU and KVM environment. Select <guimenu>KVM tools</guimenu> to use the <systemitem class="library">libvirt</systemitem>-based management stack as well. Confirm with <guimenu>Accept</guimenu>.</para>
            </step>
            <step>
               <para>YaST offers to automatically configure a network bridge on the VM Host Server. It ensures proper networking capabilities of the VM Guest. Agree to do so by selecting <guimenu>Yes</guimenu>, otherwise choose <guimenu>No</guimenu>.</para>
            </step>
            <step>
               <para>After the setup has been finished, you can start creating and configuring VM Guests. Rebooting the VM Host Server is not required.</para>
            </step>
         </procedure>
         <procedure>
            <title>Installing the Xen environment</title>
            <para>To install the Xen virtualization environment, proceed as follows:</para>
            <step>
               <para>Start YaST and select<menuchoice>
                     <guimenu>Virtualization</guimenu>
                     <guimenu>Install Hypervisor and Tools</guimenu>
                  </menuchoice>.</para>
            </step>
            <step>
               <para>Select <guimenu>Xen server</guimenu> for a minimal installation of Xen environment. Select <guimenu>Xen tools</guimenu> to use the <systemitem class="library">libvirt</systemitem>-based management stack as well. Confirm with <guimenu>Accept</guimenu>.</para>
            </step>
            <step>
               <para>YaST offers to automatically configure a network bridge on the VM Host Server. It ensures proper networking capabilities of the VM Guest. Agree to do so by selecting <guimenu>Yes</guimenu>, otherwise choose <guimenu>No</guimenu>.</para>
            </step>
            <step>
               <para>After the setup has been finished, you need to reboot the machine with the <emphasis>Xen kernel</emphasis>.</para>
               <tip>
                  <title>Default boot kernel</title>
                  <para>If everything works as expected, change the default boot kernel with YaST and make the Xen-enabled kernel the default. For more information about changing the default kernel, see <phrase xmlns:l="http://docbook.org/ns/docbook/l10n" role="document-xref">Book <quote>Administration Guide</quote>, </phrase>
                     <xref linkend="sec-grub2-yast2-config" xrefstyle="%label &#34;%c&#34;"/>.</para>
               </tip>
            </step>
         </procedure>
      </sect2>
      <sect2 xml:id="install-virtualization-components-pattern">
         <title>Installing specific installation patterns</title>
         <para>Related software packages from <phrase role="productname">SUSE Linux Enterprise Server</phrase> software repositories are organized into <emphasis>installation patterns</emphasis>. You can use these patterns to install specific virtualization components on an already running <phrase role="productname">SUSE Linux Enterprise Server</phrase>. Use <command>zypper</command> to install them:</para>
         <screen>zypper install -t pattern <replaceable>PATTERN_NAME</replaceable></screen>
         <para>To install the KVM environment, consider the following patterns:</para>
         <variablelist>
            <varlistentry>
               <term>
                  <literal>kvm_server</literal>
               </term>
               <listitem>
                  <para>Installs basic VM Host Server with the KVM and QEMU environments.</para>
               </listitem>
            </varlistentry>
            <varlistentry>
               <term>
                  <literal>kvm_tools</literal>
               </term>
               <listitem>
                  <para>Installs <systemitem class="library">libvirt</systemitem> tools for managing and monitoring VM Guests in KVM environment.</para>
               </listitem>
            </varlistentry>
         </variablelist>
         <para>To install the Xen environment, consider the following patterns:</para>
         <variablelist>
            <varlistentry>
               <term>
                  <literal>xen_server</literal>
               </term>
               <listitem>
                  <para>Installs a basic Xen VM Host Server.</para>
               </listitem>
            </varlistentry>
            <varlistentry>
               <term>
                  <literal>xen_tools</literal>
               </term>
               <listitem>
                  <para>Installs <systemitem class="library">libvirt</systemitem> tools for managing and monitoring VM Guests in Xen environment.</para>
               </listitem>
            </varlistentry>
         </variablelist>
      </sect2>
   </sect1>
   <sect1 xml:id="sec-vt-installation-nested-vms">
      <title>Enable nested virtualization in KVM</title>
      <important>
         <title>Technology preview</title>
         <para>KVM's nested virtualization is still a technology preview. It is provided for testing purposes and is not supported.</para>
      </important>
      <para>Nested guests are KVM guests run in a KVM guest. When describing nested guests, we use the following virtualization layers:</para>
      <variablelist>
         <varlistentry>
            <term>L0</term>
            <listitem>
               <para>A bare metal host running KVM.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>L1</term>
            <listitem>
               <para>A virtual machine running on L0. Because it can run another KVM, it is called a <emphasis>guest hypervisor</emphasis>.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>L2</term>
            <listitem>
               <para>A virtual machine running on L1. It is called a <emphasis>nested guest</emphasis>.</para>
            </listitem>
         </varlistentry>
      </variablelist>
      <para>Nested virtualization has many advantages. You can benefit from it in the following scenarios:</para>
      <itemizedlist>
         <listitem>
            <para>Manage your own virtual machines directly with your hypervisor of choice in cloud environments.</para>
         </listitem>
         <listitem>
            <para>Enable the live migration of hypervisors and their guest virtual machines as a single entity.</para>
            <note>
               <para>Live migration of a nested VM Guest is not supported.</para>
            </note>
         </listitem>
         <listitem>
            <para>Use it for software development and testing.</para>
         </listitem>
      </itemizedlist>
      <para>To enable nesting temporarily, remove the module and reload it with the <option>nested</option> KVM module parameter:</para>
      <itemizedlist>
         <listitem>
            <para>For Intel CPUs, run:</para>
            <screen><prompt>&gt;</prompt><command>sudo</command> modprobe -r kvm_intel &amp;&amp; modprobe kvm_intel nested=1
</screen>
         </listitem>
         <listitem>
            <para>For AMD CPUs, run:</para>
            <screen><prompt>&gt;</prompt><command>sudo</command> modprobe -r kvm_amd &amp;&amp; modprobe kvm_amd nested=1
</screen>
         </listitem>
      </itemizedlist>
      <para>To enable nesting permanently, enable the <option>nested</option> KVM module parameter in the <filename>/etc/modprobe.d/kvm_*.conf</filename> file, depending on your CPU:</para>
      <itemizedlist>
         <listitem>
            <para>For Intel CPUs, edit <filename>/etc/modprobe.d/kvm_intel.conf</filename> and add the following line:</para>
            <screen>options kvm_intel nested=1</screen>
         </listitem>
         <listitem>
            <para>For AMD CPUs, edit <filename>/etc/modprobe.d/kvm_amd.conf</filename> and add the following line:</para>
            <screen>options kvm_amd nested=1</screen>
         </listitem>
      </itemizedlist>
      <para>When your L0 host is capable of nesting, you can start an L1 guest in one of the following ways:</para>
      <itemizedlist>
         <listitem>
            <para>Use the <option>-cpu host</option> QEMU command line option.</para>
         </listitem>
         <listitem>
            <para>Add the <literal>vmx</literal> (for Intel CPUs) or the <literal>svm</literal> (for AMD CPUs) CPU feature to the <option>-cpu</option> QEMU command line option, which enables virtualization for the virtual CPU.</para>
         </listitem>
      </itemizedlist>
      <sect2 xml:id="sec-vt-installation-nested-vms-esxi">
         <title>VMware ESX as a guest hypervisor</title>
         <para>If you use VMware ESX as a guest hypervisor on top of a KVM bare metal hypervisor, you may experience unstable network communication. This problem occurs especially between nested KVM guests and the KVM bare metal hypervisor or external network. The following default CPU configuration of the nested KVM guest is causing the problem:</para>
         <screen>&lt;cpu mode='host-model' check='partial'/&gt;</screen>
         <para>To fix it, modify the CPU configuration as follow:</para>
         <screen>
[...]
&lt;cpu mode='host-passthrough' check='none'&gt;
 &lt;cache mode='passthrough'/&gt;
&lt;/cpu&gt;
[...]
</screen>
      </sect2>
   </sect1>
</chapter>
