<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook"
         xmlns:its="http://www.w3.org/2005/11/its"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         version="5.2"
         xml:id="cha-qemu-ga">
   <info>
      <title>QEMU guest agent</title>
   </info>
   <para>The QEMU guest agent (GA) runs inside the VM Guest and allows the VM Host Server to run commands in the guest operating system via <systemitem class="library">libvirt</systemitem>. It supports many functions—for example, getting details about guest file systems, freezing and thawing file systems, or suspending or rebooting a guest.</para>
   <para>QEMU GA is included in the <package>qemu-guest-agent</package> package and is installed, configured and activated by default on KVM virtual machines.</para>
   <para>QEMU GA is installed in Xen virtual machines, but it is not activated by default. Although it is possible to use QEMU GA with Xen virtual machines, there is no integration with libvirt as described below for KVM virtual machines. To use QEMU GA with Xen, a channel device must be added to the VM Guest configuration. The channel device includes a Unix domain socket path on the VM Host Server for communicating with QEMU GA.</para>
   <screen>&lt;channel type='unix'&gt;
  &lt;source mode='bind' path='/example/path'/&gt;
  &lt;target type='xen' name='org.qemu.guest_agent.0'/&gt;
&lt;/channel&gt;</screen>
   <sect1 xml:id="cha-qemu-ga-libvirt-general">
      <title>Running QEMU GA commands</title>
      <para>QEMU GA includes many built-in commands that do not have direct <systemitem class="library">libvirt</systemitem> counterparts. Refer to <xref linkend="cha-qemu-ga-moreinfo"/> to find the complete list. You can run all the QEMU GA commands by using <systemitem class="library">libvirt</systemitem>'s general purpose command <command>qemu-agent-command</command>:</para>
      <screen>virsh qemu-agent-command <replaceable>DOMAIN_NAME</replaceable> '{"execute":"<replaceable>QEMU_GA_COMMAND</replaceable>"}'</screen>
      <para>For example:</para>
      <screen><prompt>&gt;</prompt><command>sudo</command> virsh qemu-agent-command sle15sp2 '{"execute":"guest-info"}' --pretty
{
"return": {
  "version": "4.2.0",
  "supported_commands": [
    {
      "enabled": true,
      "name": "guest-get-osinfo",
      "success-response": true
    },
[...]
</screen>
   </sect1>
   <sect1 xml:id="cha-qemu-ga-commands">
      <title>
         <command>virsh</command> commands that require QEMU GA</title>
      <para>Several <command>virsh</command> commands require QEMU GA for their functionality. For example, the following ones:</para>
      <variablelist>
         <varlistentry>
            <term>
               <command>virsh guestinfo</command>
            </term>
            <listitem>
               <para>Prints information about the guest from the guest's point of view.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh guestvcpus</command>
            </term>
            <listitem>
               <para>Queries or changes the state of virtual CPUs from the guest's point of view.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh set-user-password</command>
            </term>
            <listitem>
               <para>Sets the password for a user account in the guest.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh domfsinfo</command>
            </term>
            <listitem>
               <para>Shows a list of mounted file systems within the running domain.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh dompmsuspend</command>
            </term>
            <listitem>
               <para>Suspends a running guest.</para>
            </listitem>
         </varlistentry>
      </variablelist>
   </sect1>
   <sect1 xml:id="cha-qemu-ga-libvirt">
      <title>Enhancing <systemitem class="library">libvirt</systemitem> commands</title>
      <para>If QEMU GA is enabled inside the guest, several <command>virsh</command> subcommands have enhanced functionality when run in the <emphasis>agent</emphasis> mode. The following list includes only certain examples of them. For a complete list, see the <command>virsh</command> man page and search for the <literal>agent</literal> string.</para>
      <variablelist>
         <varlistentry>
            <term>
               <command>virsh shutdown --mode agent</command> and <command>virsh reboot --mode agent</command>
            </term>
            <listitem>
               <para>This method of shutting down or rebooting leaves the guest clean for its next run, similar to the ACPI method.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh domfsfreeze</command> and <command>virsh domfsthaw</command>
            </term>
            <listitem>
               <para>Instructs the guest to make its file system quiescent—to flush all I/O operations in the cache and leave volumes in a consistent state, so that no checks are needed when they are remounted.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh setvcpus --guest</command>
            </term>
            <listitem>
               <para>Changes the number of CPUs assigned to a guest.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh domifaddr --source agent</command>
            </term>
            <listitem>
               <para>Queries the QEMU GA for the guest's IP address.</para>
            </listitem>
         </varlistentry>
         <varlistentry>
            <term>
               <command>virsh vcpucount --guest</command>
            </term>
            <listitem>
               <para>Prints information about the virtual CPU counts from the perspective of the guest.</para>
            </listitem>
         </varlistentry>
      </variablelist>
   </sect1>
   <sect1 xml:id="cha-qemu-ga-moreinfo">
      <title>More information</title>
      <itemizedlist>
         <listitem>
            <para>A complete list of commands supported by the QEMU GA is at <link xlink:href="https://www.qemu.org/docs/master/interop/qemu-ga-ref.html"/>.</para>
         </listitem>
         <listitem>
            <para>The <command>virsh</command> man page (<command>man 1 virsh</command>) includes descriptions of the commands that support the QEMU GA interface.</para>
         </listitem>
      </itemizedlist>
   </sect1>
</chapter>
